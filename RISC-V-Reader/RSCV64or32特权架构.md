# RSCV64or32特权架构

### 机器的特权状态

 采用RV64G指令集的处理器，定义了三种特权模式：运行在最高特权级的机器模式（machine mode），运行在次高特权级的监管者模式

（supervisor mode），以及最低

特权级的用户模式（user mode）。机器模式是启动后，计算机所处的模式，在该模式

下能够运行所有特权指令，访问所有内存空间。监管者模式所处的特权级略低于机器模

式，但仍能够运行部分特权指令，以及访问机器模式所规定的所有内存空间。用户模式

的特权级最低，无法执行改变机器状态的特权指令，和访问超过应用程序范围的内存空

间。为后续讨论的方便，我们有时会简称机器模式为M模式，监管者模式为S模式，用户

模式为U模式。

实际上，RISC-V指令集的设计综合考虑了从微型嵌入式设备到云服务器的多种应用场

合，根据应用场合的不同，就出现了多种特权级的组合。例如，对于简单的嵌入式设备

（例如我们的U盘控制器）只设计机器模式（M）就足够了；对于有安全性考虑的嵌入式

设备（例如车辆的中控、路由器等），则需要搭配机器模式和用户模式的组（M+U）；

对于通用计算机（例如台式电脑、手机，以及云服务器），由于需要运行通用操作系

统，则需要机器模式、监管模式以及用户模式的组合（M+S+U）。由于本书的主题是操

作系统，在以后的实验中我们将假设我们的RISC-V计算机采用了M+S+U的组合。

![fig1_3](https://gitee.com/syivester/pke-doc/raw/master/pictures/fig1_3.png)

图1.3 RISC-V机器的特权模式与特权级转换

通过《操作系统原理》课我们知道，**现代的处理器定义不同特权级的根本原因，是为了**

**对操作系统进行保护**。例如，让操作系统运行在较高的特权模式，而用户代码则运

行在较低的特权模式，以防止用户态代码执行恶意的动作破坏操作系统。然而，用户态

的代码在它的生命周期里往往会要求做一些“合法”的特权模式行为（例如进行I/O，典型

例子如常用的printf函数），这就意味着处理器同时需要支持特权模式的转换（control 

transfer）。在RISC-V处理器中，实现这种特权模式转换的工具就是中断，当执行在低特

权模式的代码被中断时，处理器将进入更高特权模式执行中断处理例程来处理打断（低

特权）代码执行的事件。中断处理完成后，处理器将从高特权模式返回低特权模式。这

里的中断有时被称为异常或系统调用，我们将在1.4节详细讨论中断的分类、相关术语和

处理过程。需要注意的是，RISC-V处理器可以实现跨特权模式的转换，例如从U模式直接

进入M模式，或者从M模式返回U模式，这些转换的发生都取决于机器的状态寄存器的设

置。

RISC-V为每一种特权模式定义了一组寄存器，用于控制机器的状态（status）以及实现状

态的转换。对于操作系统而言，比较重要的是机器模式和监管模式的一组寄存器

（Control and Status Registers，简写为CSRs），下面我们将分别讨论这两种模式下的

CSR，以及状态转换的实现。需要说明的是，关于RISC-V机器的特权状态，[RISC-V 

instruction set manual]是一个比较好的文档，这里我们将重点讨论与操作系统相关的内容。

​	



**机器模式下的CSR**

